trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

stages:
# --------------------------
# BUILD STAGE
# --------------------------
- stage: Build
  displayName: "Build Frontend"
  jobs:
    - job: BuildFrontend
      displayName: "Build Vue/React/Angular App"
      steps:
        - checkout: self

        # Install Node
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: "Install Node.js"

        # Install packages
        - script: |
            cd frontend
            npm install
          displayName: "Install NPM Dependencies"

        # Build frontend
        - script: |
            cd frontend
            npm run build
          displayName: "Build App"

        # Publish build output as artifact
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: 'frontend/dist'
            ArtifactName: 'frontend_dist'
            publishLocation: 'Container'
          displayName: "Publish Frontend Build Artifact"

# --------------------------
# DEPLOY STAGE
# --------------------------
- stage: Deploy
  displayName: "Deploy to Azure Static Web App"
  dependsOn: Build
  jobs:
    - job: DeployJob
      displayName: "Deploy Static Web App"
      steps:
        - task: DownloadBuildArtifacts@0
          inputs:
            artifactName: 'frontend_dist'
            downloadPath: '$(Pipeline.Workspace)/drop'

        # Azure Static Web App deploy task
        - task: AzureStaticWebApp@0
          displayName: "Deploy to Azure Static Web App"
          inputs:
            app_location: 'frontend'
            output_location: 'dist'
            skip_app_build: true
            azure_static_web_apps_api_token: $(SWA_DEPLOYMENT_TOKEN)
